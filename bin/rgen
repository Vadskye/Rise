#!/usr/bin/env fish
g rise; or exit 1

set has_art 1 
g utransfer; or set has_art 0
cd "Rise Art"; or set has_art 0

if [ "$has_art" -eq "1" ]
    g rise
    # Remove existing image files
    for dir in lib/images/*
        rm $dir/*
    end

    # Copy images
    cp -r (p utransfer)/Rise\ Art/introduction lib/images/
    cp -r (p utransfer)/Rise\ Art/characters lib/images/
    cp -r (p utransfer)/Rise\ Art/classes lib/images/
    cp -r (p utransfer)/Rise\ Art/combat lib/images/
    cp -r (p utransfer)/Rise\ Art/core\ mechanics lib/images/
    cp -r (p utransfer)/Rise\ Art/equipment lib/images/
    cp -r (p utransfer)/Rise\ Art/feats lib/images/
    cp -r (p utransfer)/Rise\ Art/mystic\ spheres lib/images/
    cp -r (p utransfer)/Rise\ Art/monsters lib/images/
    cp -r (p utransfer)/Rise\ Art/the\ universe lib/images/
    cp -r (p utransfer)/Rise\ Art/optional\ rules lib/images/

    # Convert images to limit pdf size
    for dir in lib/images/*
        echo "Converting images in $dir"
        # Shrink large images and convert to jpg
        magick.exe mogrify -resize 512x512 -format jpg $dir/*
        # Remove the old png images
        rm $dir/*.png
    end

    # Move emoji after jpg conversion to retain original transparency
    cp -r (p utransfer)/Rise\ Art/emoji lib/images/

    # clean up any jpg conversions
    rm lib/images/emoji/*.jpg
else
    echo "Skipping art generation"
end

echo "generating autogenerated files"
# Generate autogenerated files
mkdir -p core_book/generated
rm core_book/generated/*
mkdir -p comprehensive_codex/generated
rm comprehensive_codex/generated/*
g rust
./src/bin/generate_rust_files.fish

g rts
npx tsc --incremental
# npm run script -- src/scripts/generate_latex.js -t monsters -o ../core_book/generated/monster_descriptions.tex
npm run script -- src/scripts/generate_latex.js -t mystic_sphere_lists -o ../comprehensive_codex/generated/mystic_sphere_lists.tex
npm run script -- src/scripts/generate_latex.js -t mystic_sphere_spell_summaries -o ../comprehensive_codex/generated/mystic_sphere_spell_summaries.tex
npm run script -- src/scripts/generate_latex.js -t mystic_sphere_ritual_summaries -o ../comprehensive_codex/generated/mystic_sphere_ritual_summaries.tex
npm run script -- src/scripts/generate_latex.js -t mystic_sphere_descriptions -o ../comprehensive_codex/generated/mystic_sphere_descriptions.tex
npm run script -- src/scripts/generate_latex.js -t ritual_descriptions -o ../comprehensive_codex/generated/ritual_descriptions.tex
npm run script -- src/scripts/generate_latex.js -t combat_style_lists -o ../comprehensive_codex/generated/combat_style_lists.tex
npm run script -- src/scripts/generate_latex.js -t combat_style_summaries -o ../comprehensive_codex/generated/combat_style_summaries.tex
npm run script -- src/scripts/generate_latex.js -t combat_style_descriptions -o ../comprehensive_codex/generated/combat_style_descriptions.tex
g rise
rm -r html_book/generated
cp -r core_book/generated html_book/generated
cp -r comprehensive_codex/generated/* html_book/generated
