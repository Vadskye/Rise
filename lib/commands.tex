% These paths have to be defined relative to the *compilation* file path,
% not the file path of lib/commands. Fortunately, all compilation files
% are one level up from the root directory, so this should work.
\input{../lib/buffs_and_debuffs.tex}
\input{../lib/damage.tex}
\input{../lib/links.tex}
\input{../lib/tags.tex}

\newcommand{\lcaption}[1]{\caption[]{#1}\label{cap:#1}}
\newcommand{\columncaption}[1]{\lcaption{#1}\vspace{0.5em}}

% Create a \fsize length which represents the current font size. Used for \sparkle
\makeatletter
\newcommand*\fsize{\dimexpr\f@size pt\relax}
\makeatother

\newcommand{\minus}{\texttt{-{}}}
\newcommand{\plus}{\texttt{+}}    %Use a smaller positive marker for use directly adjacent to numbers
\newcommand{\add}{\texttt{+}\xspace}    %Use a smaller plus sign
\newcommand{\sub}{\texttt{-}\xspace}
\newcommand{\mult}{x}
\newcommand{\x}{x\xspace}
\newcommand{\subcf}[1]{\parhead{#1}}    %Bold sub-class-feature headers
\newcommand{\subsk}[1]{\par \emph{#1}:}    %Italicize sub-skill headers

\newcommand{\subparhead}[1]{\par\emph{#1}:}
\newcommand{\tb}[1]{\textbf{#1}}    %Bold the header of tables
\newcommand{\tdash}{\hskip 0.1em---\xspace}    %A null entry in a table
\newcommand{\ccol}{\centering\arraybackslash}    %Center columns
\newcommand{\lcol}{\raggedright\arraybackslash}
\newcommand{\rcol}{\raggedleft\arraybackslash}

\newcommand{\fn}[1]{\textsuperscript{#1}}

\newcommand{\tind}{\hspace{1em}}

\newcommand{\spelldesc}[1]{\par\noindent \textit{#1}}

\newcommand{\rngshort}{Short \reminder{30 ft.}\xspace}
\newcommand{\rngmed}{Medium \reminder{60 ft.}\xspace}
\newcommand{\rnglong}{Long \reminder{90 ft.}\xspace}
\newcommand{\rngdist}{Distant \reminder{120 ft.}\xspace}

\newcommand{\shortrange}{\shortrangeless range\xspace}
\newcommand{\medrange}{\medrangeless range\xspace}
\newcommand{\longrange}{\longrangeless range\xspace}
\newcommand{\distrange}{\distrangeless range\xspace}
\newcommand{\extrange}{\extrangeless range\xspace}

\newcommand{\shortrangeless}{Short \reminder{30 ft.}\xspace}
\newcommand{\medrangeless}{Medium \reminder{60 ft.}\xspace}
\newcommand{\longrangeless}{Long \reminder{90 ft.}\xspace}
\newcommand{\distrangeless}{Distant \reminder{120 ft.}\xspace}
\newcommand{\extrangeless}{Extreme \reminder{180 ft.}\xspace}

\newcommand{\areatiny}{Tiny \reminder{5 ft.}\xspace}
\newcommand{\areasmall}{Small \reminder{15 ft.}\xspace}
\newcommand{\areamed}{Medium \reminder{30 ft.}\xspace}
\newcommand{\arealarge}{Large \reminder{60 ft.}\xspace}
\newcommand{\areahuge}{Huge \reminder{90 ft.}\xspace}
\newcommand{\areagarg}{Gargantuan \reminder{120 ft.}\xspace}

\newcommand{\tinyarea}{Tiny \reminder{5 ft.}\xspace}
\newcommand{\smallarea}{Small \reminder{15 ft.}\xspace}
\newcommand{\medarea}{Medium \reminder{30 ft.}\xspace}
\newcommand{\largearea}{Large \reminder{60 ft.}\xspace}
\newcommand{\hugearea}{Huge \reminder{90 ft.}\xspace}
\newcommand{\gargarea}{Gargantuan \reminder{120 ft.}\xspace}

\newcommand{\tinyarealong}{Tiny \reminder{5 ft.\ long}\xspace}
\newcommand{\smallarealong}{Small \reminder{15 ft.\ long}\xspace}
\newcommand{\medarealong}{Medium \reminder{30 ft.\ long}\xspace}
\newcommand{\largearealong}{Large \reminder{60 ft.\ long}\xspace}
\newcommand{\hugearealong}{Huge \reminder{90 ft.\ long}\xspace}
\newcommand{\gargarealong}{Gargantuan \reminder{120 ft.\ long}\xspace}

\newcommand{\featpre}{\parhead{Prerequisite} }
\newcommand{\featpres}{\parhead{Prerequisites} }
%featref no target

\newcommand{\skill}[2]{\section{#1 (#2)}\label{#1}}

\newcommand{\reminder}[1]{\textcolor{darkgray}{\textit{(#1)}}}

\newcommand{\spelltablecolumns}{>{\lcol}X l}
\newcommand{\spelllevelschool}[2]{\spelllvl{#1} & #2 \\}
\newcommand{\spelllevelnew}[3]{\tb{\nth{#1} level} #2 & #3 \\}

\newcommand{\dismissable}{}

\ExplSyntaxOn

\DeclareDocumentCommand{\parhead}{s m o}
{
    \par
    \IfNoValueTF{#3}
    {\textbf{#2}:}
    {\textbf{#2}~[#3]:}\xspace
}

\DeclareDocumentCommand{\parheadindent}{s m o}
{
    % Why are two indents required here? so dumb
    \par\indent\indent
    \IfNoValueTF{#3}
    {\textbf{#2}:}
    {\textbf{#2}~[#3]:}\xspace
}

\DeclareDocumentCommand{\rank}{m}
{
    \par \noindent \hangindent=0.5em
    Rank~#1:\xspace
}

\DeclareDocumentCommand{\featlevel}{m}
{
    \par \noindent
    \textit{Level~#1}:
}

\DeclareDocumentCommand{\rankline}{}
{
    \par
    \vspace{-0.5em}
    \noindent
    \hrulefill
    \par\noindent
}

% If #1 = #2
%     print #3.
% Elseif #4 is provided
%     print #4
\DeclareDocumentCommand{\ifstr}{m m m o}
{
    \ifnum 0=\pdfstrcmp{#1}{#2}
        #3
    \else
        \IfValueT{#4}{#4}
    \fi
}

% args:
%   pre-spell header spell name, spell name modifier (Greater, etc.)
\DeclareDocumentCommand{\spellhead}{o m o}
{
    \IfValueTF{#1}
    {\item[#1]}
    {\item}
    \textbf{
        \IfValueTF{#3}
        {
            \hyperlink{spell:#3~#2}{#2,~#3}
            %\pageref{spell:#3~#2}
        }
        {
            \hyperlink{spell:#2}{#2}
            %\pageref{spell:#2}
        }
    }:
}

% args:
%   pre-spell header spell name, spell name modifier (Greater, etc.)
\DeclareDocumentCommand{\maneuverhead}{o m o}
{
    \IfValueTF{#1}
    {\item[#1]}
    {\item}
    \textbf{
        \IfValueTF{#3}
        {
            \hyperlink{maneuver:#3~#2}{#2,~#3}
            \hypertargetraised{maneuverlist:#3~#2}
        }
        {
            \hyperlink{maneuver:#2}{#2}
            \hypertargetraised{maneuverlist:#2}
        }
    }:
}

\DeclareDocumentCommand{\imath}{m}
{
    %\pgfmathparse{int(floor(#1))}\pgfmathresult
    \pgfmathsetmacro{\TempVar}{int (floor (#1))}
    \TempVar
}

\DeclareDocumentCommand{\imathparse}{m}
{
    \pgfmathsetmacro{\TempVar}{int (floor (#1))}
}

\DeclareDocumentCommand{\imathresult}{}
{
    \TempVar
}

\DeclareDocumentCommand{\spelltabular}{}
{
    \par\noindent
    \begin{tabularx}{\columnwidth}{>{\lcol}X l}
}

\DeclareDocumentCommand{\spelltabularcompressed}{}
{
    \renewcommand{\arraystretch}{0.5}
    \par\noindent
    \begin{tabularx}{\linewidth}{@{}~>{\lcol}X~l~@{}}
}

% args:
%   class name
%   level, if any
%   ability name
%   ability name suffix, like a magic sparkle
\DeclareDocumentCommand{\cf}{m o m o}
{
    \subsubsection{
        \textmd{
        \IfValueT{#2}{Rank~#2~--~}
        #3
        \IfValueT{#4}{#4}
        }
    }
    \label{#1:#3}
}

\DeclareDocumentCommand{\magicalcf}{m o m}
{ \cf{#1}[#2]{#3}[\sparkle] }

% feat level
% args:
%   level
%   name
%   suffix
\DeclareDocumentCommand{\ff}{o m o}
{
    \par
    \IfValueTF{#1}
    {
        { \nth{#1}~--~\textbf{#2}\IfValueT{#3}{#3}: }
    }
    {
        { \textbf{#2\IfValueT{#3}{#3}}: }
    }
}

\DeclareDocumentCommand{\magicalff}{o m}
{
    \setlength{\parindent}{0.8\parindent}\par
    \IfValueTF{#1}
    {
        { \nth{#1}~--\sparkle \, \textbf{#2}: }
    }
    {
        { \textbf{#2}: }
    }
}

\DeclareDocumentCommand{\itemhead}{s m o}
{
    \item
    \IfBooleanTF{#1}
    {
        \textbf{#2}
    }
    {
        \textit{#2}
    }
    \IfValueT{#3}{
        % without the braces the space is swallowed for some reason
        {}~{}[#3]
    }:
}

\DeclareDocumentCommand{\magicalitemhead}{s m o}
{
    \IfBooleanTF{#1}
    {
        \IfValueTF{#3}{
            \itemhead*{#2 \sparkle}[#3]
        }{
            \itemhead*{#2 \sparkle}
        }
    }
    {
        \IfValueTF{#3}{
            \itemhead{#2 \sparkle}[#3]
        }{
            \itemhead{#2 \sparkle}
        }
    }
}

\DeclareDocumentCommand{\hit}{}
{
    % Adding a vspace increases the spacing. Although this looks negative, it still increases the spacing relative to the previous line compared to not including a vspace at all.
    \par \vspace{-0.1em} \textbf{Hit}:\xspace
}

\DeclareDocumentCommand{\injury}{}
{
    \par \vspace{-0.1em} \textbf{Injury}:\xspace
}

\DeclareDocumentCommand{\crit}{}
{
    \par \textbf{Critical~hit}:\xspace
}

\DeclareDocumentCommand{\miss}{}
{
    \par \textbf{Miss}:\xspace
}

\DeclareDocumentCommand{\tableheaderrule}{}
{
    \vspace{-0.25em}
    \\
    \bottomrule
}

\DeclareDocumentCommand{\targetrule}{s}{
    \par
    \vspace{-0.5em}
    \noindent
    \hrulefill
    \par\noindent
}

\DeclareDocumentCommand{\target}{m}{
    \par\noindent
    Target:~#1
    \targetrule*
}

\DeclareDocumentCommand{\targets}{m}{
    \par\noindent
    Targets:~#1
    \targetrule
}

\DeclareDocumentCommand{\monsep}{}{
    \hspace{0.8em}
}

\DeclareDocumentCommand{\monsubsection}{m m m}
{
    \setlength\multicolsep{0pt}
    \noindent
    \begin{minipage}{0.6\linewidth}
      \lowercase{\hypertarget{mon:#1}{}}
      \label{mon:#1}
      \hypertarget{mon:#1}
          {\subsection*{#1}}
    \end{minipage}
    \begin{minipage}{0.4\linewidth}
      \begin{flushright}
        #2 \par #3
      \end{flushright}
    \end{minipage}
}

\DeclareDocumentCommand{\monsubsubsection}{m o m o}
{
    \setlength\multicolsep{0pt}
    \noindent
    \begin{multicols}{2}
        \IfValueTF{#2}
        {
            \lowercase{\hypertarget{mon:#2~#1}{}}
            \label{mon:#2~#1}
            \hypertarget{mon:#2~#1}
                {\subsubsection{#1,~#2}}
        }
        {
            \lowercase{\hypertarget{mon:#1}{}}
            \label{mon:#1}
            \hypertarget{mon:#1}
                {\subsubsection*{#1}}
        }

        \columnbreak
        \begin{flushright}
            Level~#3
            \IfValueT{#4}
            {
                % For some reason this space is eaten if we don't use {} here
                {}~--~\textbf{#4}
            }
        \end{flushright}
    \end{multicols}
}

\DeclareDocumentCommand{\monstersize}{m}{
    \vspace{-1.25em}
    \spelltwocol{}{#1}
    \vspace{0em}
}

\DeclareDocumentCommand{\monsterknowledgeheader}{m}{
    \vspace{0.25em}
    \par\noindent {\large #1~Lore}
    \vspace{0.25em}
}

\DeclareDocumentCommand{\monsterabilitiesheader}{m}{
    \vspace{0.25em}
    \par\noindent {\large #1~Abilities}
    \vspace{0.25em}
}

\DeclareDocumentCommand{\tablebookmark}{m m}{
    \pdfbookmark[1]{Table~-~#1}{#2}
}

\makeatletter
 \newcommand{\hypertargetraised}[1]{\Hy@raisedlink{\hypertarget{#1}{}}}
\makeatother

\DeclareDocumentCommand{\advancement}{}{
    \parhead{Advancement}
}

\DeclareDocumentCommand{\itemname}{o m o}
{
    {
        \protect
        \hypertargetraised{item:#2}{
            \protect
            \hyperlink{itemtable:#2}{#2}
        }
    }
    \label{item:#2}
}

\DeclareDocumentCommand{\itemabilityheader}{s m m}{
    \RaggedRight
    \hypertargetraised{item:#2}{}
    \spelltwocol{
        {\normalsize \textbf{\hyperlink{itemtable:#2}{#2}}}
        \IfBooleanT{#1}{\sparkle}
    }{
        #3
    }
    \label{item:#2}
}

\DeclareDocumentCommand{\upgraderank}{m m}
{
    \rank{\hypertargetraised{item:#1}{#2\label{item:#1}}}
}

% \, is a small non-breaking space
\DeclareDocumentCommand{\sparkle}{}{\,\sparklespaceless}
\DeclareDocumentCommand{\poison}{}{\,\poisonspaceless}
\DeclareDocumentCommand{\potion}{}{\,\potionspaceless}

\DeclareDocumentCommand{\magical}{}{\glossterm{magical}\sparkle\xspace}

\DeclareDocumentCommand{\nonsectionlabel}{m}
{
    \phantomsection \label{#1}
}

% Create a section with a graphic after the section title,
% ensuring that the graphic and the section title stay on the same page.
% Args:
%   *: if provided, create \label{sectiontitle}
%   sectiontitle: Title of the section
%   graphicsargs: Generally, \width=columnwidth
%   graphicspath: Path to the graphic
\DeclareDocumentCommand{\sectiongraphic}{s m m m}
{
  \begin{minipage}{\columnwidth}
  \section{#2}
  \IfBooleanT{#1}{\label{#2}}
  \includegraphics[#3]{#4}
  \vspace{0.5em}
  \end{minipage}
}

\DeclareDocumentCommand{\subsectiongraphic}{s m m m}
{
  \begin{forcesamepage}
  \subsection{#2}
  \IfBooleanT{#1}{\label{#2}}
  \includegraphics[#3]{#4}
  \vspace{0.25em}
  \end{forcesamepage}
}

\DeclareDocumentCommand{\subsubsectiongraphic}{s m m m}
{
  \begin{forcesamepage}
  \subsubsection{#2}
  \IfBooleanT{#1}{\label{#2}}
  \includegraphics[#3]{#4}
  \end{forcesamepage}
}

\ExplSyntaxOff

\newcommand{\classbasics}[1]{\par\noindent\textbf{#1}:}

\newcommand{\pari}{\par\noindent}

\newcommand{\abilitycost}{\par\noindent Cost:\xspace}
\newcommand{\abilityusagetime}{\par\noindent Usage time:\xspace}
\newcommand{\abilitytags}{\par\noindent Tags:\xspace}

\newcommand{\critcondition}{\crit The condition must be removed an additional time before the effect ends.}

% Because latex is confusing, the preceding noindent actually guarantees that the paragraph *will* be
% indented. That still looks fine, and it solves the problem where the first parhead would be unindented
% while every following one would be indented.
\newcommand{\domainability}[1]{\noindent\parhead{#1}}
\newcommand{\magicaldomainability}[1]{\noindent\par \textbf{#1}\sparkle: }
