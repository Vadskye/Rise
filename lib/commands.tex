\newcommand{\lcaption}[1]{\caption[]{#1}\label{cap:#1}}

% Create a \fsize length which represents the current font size. Used for \sparkle
\makeatletter
\newcommand*\fsize{\dimexpr\f@size pt\relax}
\makeatother

\newcommand{\minus}{\texttt{-{}}}
\newcommand{\plus}{\texttt{+}}    %Use a smaller positive marker for use directly adjacent to numbers
\newcommand{\add}{\texttt{+}\xspace}    %Use a smaller plus sign
\newcommand{\sub}{\texttt{-}\xspace}
\newcommand{\mult}{x}
\newcommand{\x}{x\xspace}
%NOTED BUG: Spell names with mixed capitalization (Dispel magic) will not work properly.
\newcommand{\combatstyle}[1]{\emph{\mbox{\hyperlink{style:#1}{#1}}}}    %Italicize combat styles
\newcommand{\sphere}[1]{\emph{\mbox{\hyperlink{sphere:#1}{#1}}}}    %Italicize mystic spheres
\newcommand{\ability}[1]{\mbox{\hyperlink{ability:#1}{#1}}}
\newcommand{\spell}[1]{\mbox{\hyperlink{spell:#1}{#1}}}
\newcommand{\cantrip}[1]{\mbox{\hyperlink{spell:#1}{#1}}}
\newcommand{\maneuver}[1]{\mbox{\hyperlink{maneuver:#1}{#1}}}
\newcommand{\stance}[1]{\mbox{\hyperlink{stance:#1}{#1}}}
\newcommand{\spellindirect}[2]{\hyperlink{spell:#1}{#2}}
\newcommand{\ritual}[1]{\mbox{\hyperlink{spell:#1}{#1}}}
\newcommand{\subcf}[1]{\parhead{#1}}    %Bold sub-class-feature headers
\newcommand{\subsk}[1]{\par \emph{#1}:}    %Italicize sub-skill headers

\newcommand{\subparhead}[1]{\par\emph{#1}:}
\newcommand{\tb}[1]{\textbf{#1}}    %Bold the header of tables
\newcommand{\tdash}{\hskip 0.1em---\xspace}    %A null entry in a table
\newcommand{\ccol}{\centering\arraybackslash}    %Center columns
\newcommand{\lcol}{\raggedright\arraybackslash}
\newcommand{\rcol}{\raggedleft\arraybackslash}

\newcommand{\fn}[1]{\textsuperscript{#1}}
\newcommand{\magicitem}[1]{\emph{#1}}    %For the names of items
\newcommand{\mitem}[1]{\emph{#1}}

\newcommand{\tind}{\hspace{1em}}

\newcommand{\spelldesc}[1]{\par\noindent \textit{#1}}

\newcommand{\rngshort}{Short \reminder{30 ft.}\xspace}
\newcommand{\rngmed}{Medium \reminder{60 ft.}\xspace}
\newcommand{\rnglong}{Long \reminder{90 ft.}\xspace}
\newcommand{\rngdist}{Distant \reminder{120 ft.}\xspace}

\newcommand{\shortrange}{Short \reminder{30 ft.} range\xspace}
\newcommand{\medrange}{Medium \reminder{60 ft.} range\xspace}
\newcommand{\longrange}{Long \reminder{90 ft.} range\xspace}
\newcommand{\distrange}{Distant \reminder{120 ft.} range\xspace}
\newcommand{\extrange}{Extreme \reminder{180 ft.} range\xspace}

\newcommand{\areatiny}{Tiny \reminder{5 ft.}\xspace}
\newcommand{\areasmall}{Small \reminder{15 ft.}\xspace}
\newcommand{\areamed}{Medium \reminder{30 ft.}\xspace}
\newcommand{\arealarge}{Large \reminder{60 ft.}\xspace}
\newcommand{\areahuge}{Huge \reminder{90 ft.}\xspace}
\newcommand{\areagarg}{Gargantuan \reminder{120 ft.}\xspace}

\newcommand{\tinyarea}{Tiny \reminder{5 ft.}\xspace}
\newcommand{\smallarea}{Small \reminder{15 ft.}\xspace}
\newcommand{\medarea}{Medium \reminder{30 ft.}\xspace}
\newcommand{\largearea}{Large \reminder{60 ft.}\xspace}
\newcommand{\hugearea}{Huge \reminder{90 ft.}\xspace}
\newcommand{\gargarea}{Gargantuan \reminder{120 ft.}\xspace}

\newcommand{\tinyarealong}{Tiny \reminder{5 ft. long}\xspace}
\newcommand{\smallarealong}{Small \reminder{15 ft. long}\xspace}
\newcommand{\medarealong}{Medium \reminder{30 ft. long}\xspace}
\newcommand{\largearealong}{Large \reminder{60 ft. long}\xspace}
\newcommand{\hugearealong}{Huge \reminder{90 ft. long}\xspace}
\newcommand{\gargarealong}{Gargantuan \reminder{120 ft. long}\xspace}

\newcommand{\featpre}{\parhead{Prerequisite} }
\newcommand{\featpres}{\parhead{Prerequisites} }
%featref no target

\newcommand{\skill}[2]{\section{#1 (#2)}\label{#1}}

\newcommand{\reminder}[1]{\textcolor{darkgray}{\textit{(#1)}}}

\newcommand{\blinded}{\debuff{blinded} \reminder{50\% miss chance, \minus2 Armor and Ref}\xspace}
\newcommand{\charmed}{\debuff{charmed} \reminder{friendly with charmer}\xspace}
\newcommand{\climbing}{\debuff{climbing} \reminder{\minus2 accuracy, defenses}\xspace}
\newcommand{\confused}{\debuff{confused} \reminder{\minus2 defenses, randomly attack or defend}\xspace}
\newcommand{\dazed}{\debuff{dazed} \reminder{\minus1 defenses}\xspace}
% Assume 60% hit chance, so 0.6 dpr.
% with -1 accuracy, 0.5 dpr.
% with 20% miss chance, 0.48 dpr.
% Assume 40% base hit chance; 0.3 dpr vs 0.32 dpr.
% So dazzled is about equal to -1 accuracy in common circumstances,
% but better against high-accuracy targets and worse against low-accuracy targets.
\newcommand{\dazzled}{\debuff{dazzled} \reminder{20\% miss chance, no special vision}\xspace}
\newcommand{\deafened}{\debuff{deafened} \reminder{20\% verbal spell failure}\xspace}
\newcommand{\dominated}{\debuff{dominated} \reminder{must obey commands}\xspace}
\newcommand{\frightened}{\debuff{frightened} \reminder{\minus2 Mental, -2 accuracy vs. source}\xspace}
\newcommand{\goaded}{\debuff{goaded} \reminder{\minus2 accuracy vs. non-goading creatures}\xspace}
% Too complicated to try to summarize :/
\newcommand{\grappled}{\debuff{grappled}\xspace}
\newcommand{\helpless}{\debuff{helpless} \reminder{\minus6 Armor and Ref}\xspace}
\newcommand{\immobilized}{\debuff{immobilized} \reminder{\minus4 Ref, cannot use movement speeds}\xspace}
\newcommand{\panicked}{\debuff{panicked} \reminder{\minus4 Mental, cannot attack source}\xspace}
\newcommand{\paralyzed}{\debuff{paralyzed} \reminder{cannot move}\xspace}
\newcommand{\partiallyunaware}{\debuff{partially unaware} \reminder{50\% miss chance, \minus2 Armor and Ref}\xspace}
\newcommand{\petrified}{\debuff{petrified}\xspace}
\newcommand{\prone}{\debuff{prone} \reminder{half speed, \minus2 Armor and Ref}\xspace}
\newcommand{\shaken}{\debuff{shaken} \reminder{\minus1 Mental, \minus1 accuracy vs. source}\xspace}
\newcommand{\slowed}{\debuff{slowed} \reminder{half speed, \minus2 Armor and Ref}\xspace}
\newcommand{\squeezing}{\debuff{squeezing} \reminder{\minus2 Armor and Ref}\xspace}
\newcommand{\stunned}{\debuff{stunned} \reminder{\minus2 defenses}\xspace}
\newcommand{\swimming}{\debuff{swimming} \reminder{\minus2 accuracy, defenses}\xspace}
\newcommand{\unaware}{\debuff{unaware} \reminder{\minus6 Armor and Ref}\xspace}
\newcommand{\unconscious}{\debuff{unconscious}\xspace}

\newcommand{\impervious}{\trait{impervious} \reminder{\plus4 defenses}\xspace}
\newcommand{\vulnerable}{\trait{vulnerable} \reminder{\minus4 defenses}\xspace}

\newcommand{\spelltablecolumns}{>{\lcol}X l}
\newcommand{\spelllevelschool}[2]{\spelllvl{#1} & #2 \\}
\newcommand{\spelllevelnew}[3]{\tb{\nth{#1} level} #2 & #3 \\}

\newcommand{\dismissable}{}

\ExplSyntaxOn

\DeclareDocumentCommand{\parhead}{s m o}
{
    \par
    \IfNoValueTF{#3}
    {\textbf{#2}:}
    {\textbf{#2}~[#3]:}\xspace
}

\DeclareDocumentCommand{\parheadindent}{s m o}
{
    % Why are two indents required here? so dumb
    \par\indent\indent
    \IfNoValueTF{#3}
    {\textbf{#2}:}
    {\textbf{#2}~[#3]:}\xspace
}

\DeclareDocumentCommand{\rank}{m}
{
    \par \noindent \hangindent=0.5em
    Rank~#1:\xspace
}

\DeclareDocumentCommand{\featlevel}{m}
{
    \par \noindent
    \textit{Level~#1}:
}

\DeclareDocumentCommand{\rankline}{}
{
    \par
    \vspace{-0.5em}
    \noindent
    \hrulefill
    \par\noindent
}

% If #1 = #2
%     print #3.
% Elseif #4 is provided
%     print #4
\DeclareDocumentCommand{\ifstr}{m m m o}
{
    \ifnum 0=\pdfstrcmp{#1}{#2}
        #3
    \else
        \IfValueT{#4}{#4}
    \fi
}

% args:
%   pre-spell header spell name, spell name modifier (Greater, etc.)
\DeclareDocumentCommand{\spellhead}{o m o}
{
    \IfValueTF{#1}
    {\item[#1]}
    {\item}
    \textbf{
        \IfValueTF{#3}
        {
            \hyperlink{spell:#3~#2}{#2,~#3}
            %\pageref{spell:#3~#2}
        }
        {
            \hyperlink{spell:#2}{#2}
            %\pageref{spell:#2}
        }
    }:
}

% args:
%   pre-spell header spell name, spell name modifier (Greater, etc.)
\DeclareDocumentCommand{\maneuverhead}{o m o}
{
    \IfValueTF{#1}
    {\item[#1]}
    {\item}
    \textbf{
        \IfValueTF{#3}
        {
            \hyperlink{maneuver:#3~#2}{#2,~#3}
            \hypertargetraised{maneuverlist:#3~#2}
        }
        {
            \hyperlink{maneuver:#2}{#2}
            \hypertargetraised{maneuverlist:#2}
        }
    }:
}

\DeclareDocumentCommand{\imath}{m}
{
    %\pgfmathparse{int(floor(#1))}\pgfmathresult
    \pgfmathsetmacro{\TempVar}{int(floor(#1))}
    \TempVar
}

\DeclareDocumentCommand{\imathparse}{m}
{
    \pgfmathsetmacro{\TempVar}{int(floor(#1))}
}

\DeclareDocumentCommand{\imathresult}{}
{
    \TempVar
}

\DeclareDocumentCommand{\spelltabular}{}
{
    \par\noindent
    \begin{tabularx}{\columnwidth}{>{\lcol}X l}
}

\DeclareDocumentCommand{\spelltabularcompressed}{}
{
    \renewcommand{\arraystretch}{0.5}
    \par\noindent
    \begin{tabularx}{\linewidth}{@{}~>{\lcol}X~l~@{}}
}

% args:
%   class name
%   level, if any
%   ability name
%   ability name suffix, like a magic sparkle
\DeclareDocumentCommand{\cf}{m o m o}
{
    \subsubsection{
        \IfValueT{#2}{Rank~#2~--~}
        #3
        \IfValueT{#4}{#4}
    }
    \label{#1:#3}
}

% feat level
% args:
%   level
%   name
%   suffix
\DeclareDocumentCommand{\ff}{o m o}
{
    \IfValueTF{#1}
    {
        { \nth{#1}~--~\textbf{#2}\IfValueT{#3}{#3}: }
    }
    {
        { \parhead{#2\IfValueT{#3}{#3}}}
    }
}

\DeclareDocumentCommand{\magicalff}{o m}
{
    \ff[#1]{#2}[\sparkle]
}

\DeclareDocumentCommand{\itemhead}{s m o}
{
    \item
    \IfBooleanTF{#1}
    {
        \textbf{#2}
    }
    {
        \textit{#2}
    }
    \IfValueT{#3}{
        % without the braces the space is swallowed for some reason
        {}~{}[#3]
    }
    :
}

\DeclareDocumentCommand{\featref}{s m}
{
    \hyperlink{feat:#2}{#2}
    \IfBooleanF{#1}
    {
        \hypertargetraised{ft:#2}{}
    }
}

\DeclareDocumentCommand{\magicalfeatref}{s m}
{
    \IfBooleanTF{#1}{
        \featref*{#2}\sparkle
    }{
        \featref{#2}\sparkle
    }
}

\DeclareDocumentCommand{\itemref}{s m}
{
    \hyperlink{item:#2}{#2}
    \IfBooleanF{#1}
    {
        \hypertargetraised{itemtable:#2}{}
    }
}

% #1: if provided, add a magic sparkle
% #2: class shorthand name
% #3: archetype name
\DeclareDocumentCommand{\archetyperef}{s m m}
{
    \hyperlink{archetype:#2:#3}{
        #3
        \IfBooleanT{#1}{\sparkle}
    }
    \hypertargetraised{archetypetable:#2:#3}{}
}

% #1: class shorthand name
% #2: archetype name
\DeclareDocumentCommand{\archetypedef}{s m m}
{
    \newpage
    \subsection{
        \protect
        \hypertargetraised{archetype:#2:#3}{
            \protect
            \hyperlink{archetypetable:#2:#3}{
                #3
                \IfBooleanT{#1}{\sparkle}
            }
        }
    }
    \label{#2}
}

% args:
%   #1: name of term
%   #2: alternate name of term, only used for labels/targets
%   #3: hyperlink prefix
\DeclareDocumentCommand{\termdef}{m o m}
{
    \IfValueT{#2}
    {
        % Enable this to test for missing glossary definitions
        % \label{#2}\label{#2s}
        % Enable this to test for unnecessary glossary entries
        % \pref{#2}

        \hypertargetraised{#3:#2}{}
        \hypertargetraised{#3:#2s}{}
    }
    % Enable this to test for missing glossary definitions
    % \label{#1}\label{#1s}
    % Enable this to test for unnecessary glossary entries
    % \pref{#1}

    \hypertargetraised{#3:#1}{}
    \hypertargetraised{#3:#1s}{}
    \parhead{#1}
}

\DeclareDocumentCommand{\trait}{o m}
{
    \IfValueTF{#1}
    {\termlink[#1]{#2}{trait}}
    {\termlink{#2}{trait}}
}
\DeclareDocumentCommand{\traitdef}{m m}
{
    \termdef{#1}[#2]{trait}
    \label{#1}
}

\DeclareDocumentCommand{\glossterm}{o m}
{
    \IfValueTF{#1}
    {\termlink[#1]{#2}{gloss}}
    {\termlink{#2}{gloss}}
}
\DeclareDocumentCommand{\glossdef}{m o}
{
    \IfValueTF{#2}
    {\termdef{#1}[#2]{gloss}}
    {\termdef{#1}{gloss}}
}

\DeclareDocumentCommand{\sphereterm}{o m}
{
    \IfValueTF{#1}
    {\termlink[#1]{#2}{sphere}}
    {\termlink{#2}{sphere}}
}
\DeclareDocumentCommand{\spheredef}{m o}
{
    \IfValueTF{#2}
    {\termdef{#1}[#2]{sphere}}
    {\termdef{#1}{sphere}}
}

\DeclareDocumentCommand{\debuff}{o m}
{
    \IfValueTF{#1}
    {\termlink[#1]{#2}{debuff}}
    {\termlink{#2}{debuff}}
}
\DeclareDocumentCommand{\debuffdef}{m o}
{
    \IfValueTF{#2}
    {\termdef{#1}[#2]{debuff}}
    {\termdef{#1}{debuff}}
}


\DeclareDocumentCommand{\abilitytag}{o m}
{
    \IfValueTF{#1}
    {\termlink[#1]{#2}{abilitytag}}
    {\termlink{#2}{abilitytag}}
}
\DeclareDocumentCommand{\abilitytagdef}{m o}
{
    \label{#1}
    \IfValueTF{#2}
    {\termdef{#1}[#2]{abilitytag}}
    {\termdef{#1}{abilitytag}}
}

\DeclareDocumentCommand{\weapontag}{o m}
{
    \IfValueTF{#1}
    {\termlink[#1]{#2}{weapontag}}
    {\termlink{#2}{weapontag}}
}
\DeclareDocumentCommand{\weapontagdef}{m o}
{
    \IfValueTF{#2}
    {\termdef{#1}[#2]{weapontag}}
    {\termdef{#1}{weapontag}}
}

\DeclareDocumentCommand{\hit}{}
{
    \par \textbf{Hit}:\xspace
}


\DeclareDocumentCommand{\crit}{}
{
    \par \textbf{Critical~hit}:\xspace
}

\DeclareDocumentCommand{\miss}{}
{
    \par \textbf{Miss}:\xspace
}

\DeclareDocumentCommand{\tableheaderrule}{}
{
    \vspace{-0.25em}
    \\
    \bottomrule
}

\DeclareDocumentCommand{\targetrule}{s}{
    \par
    \vspace{-0.5em}
    \noindent
    \hrulefill
    \par\noindent
}

\DeclareDocumentCommand{\target}{m}{
    \par\noindent
    Target:~#1
    \targetrule*
}

\DeclareDocumentCommand{\targets}{m}{
    \par\noindent
    Targets:~#1
    \targetrule
}

\DeclareDocumentCommand{\monsep}{}{
    \hspace{0.8em}
}

\DeclareDocumentCommand{\monstersize}{s m}{
    \IfBooleanTF{#1}{\vspace{-0.75em}}{\vspace{-1.25em}}
    \spelltwocol{}{#2}
    \vspace{0em}
}

\DeclareDocumentCommand{\monsterabilitiesheader}{m}{
    \subsubsection{#1~Abilities}
}

\DeclareDocumentCommand{\tablebookmark}{m m}{
    \pdfbookmark[1]{Table~-~#1}{#2}
}

\makeatletter
 \newcommand{\hypertargetraised}[1]{\Hy@raisedlink{\hypertarget{#1}{}}}
\makeatother

\DeclareDocumentCommand{\advancement}{}{
    \parhead{Advancement}
}

\DeclareDocumentCommand{\itemsection}{o m o}
{
    \subsubsection[#2]{
        \protect
        \hypertargetraised{item:#2}{
            \protect
            \hyperlink{itemtable:#2}{
                \IfValueTF{#3}{
                    \sectiontwocol{#2\IfValueT{#1}{#1}}{\normalsize #3}
                }{
                    #2\IfValueT{#1}{#1}
                }
            }
        }
    }
    \label{item:#2}
}

% \, is a small non-breaking space
\DeclareDocumentCommand{\sparkle}{}{\,\sparklespaceless}

\DeclareDocumentCommand{\magical}{}{\glossterm{magical}\sparkle\xspace}

% "high" scaling means it scales a lot with power, but may be weak at low power
% "low" scaling means it scales less with power, but is stronger at low power

\ExplSyntaxOff

\newcommand{\classbasics}[1]{\par\noindent\textbf{#1}:}

\newcommand{\pari}{\par\noindent}


\newcommand{\damagerankzero}[1]
{1d4 #1 damage \plus1d per 3 power}

\newcommand{\damagerankone}[1]
{1d6 #1 damage \plus1d per 2 power}
\newcommand{\damagerankonelow}[1]
{1d6 #1 damage \plus1d per 3 power}

\newcommand{\damageranktwo}[1]
{1d8 #1 damage \plus1d per 2 power}
\newcommand{\damageranktwohigh}[1]
{1d6 #1 damage plus 1d6 per 4 power}
\newcommand{\damageranktwolow}[1]
{1d8 #1 damage \plus1d per 3 power}

\newcommand{\damagerankthree}[1]
{1d8 #1 damage plus 1d6 per 4 power}
\newcommand{\damagerankthreehigh}[1]
{1d4 #1 damage plus 1d8 per 4 power}
\newcommand{\damagerankthreelow}[1]
{1d6 #1 damage plus 1d6 per 4 power}

\newcommand{\damagerankfour}[1]
{1d8 #1 damage plus 1d8 per 4 power}
\newcommand{\damagerankfourhigh}[1]
{1d8 per 3 power #1 damage} % Or could use 1d6 + d6 per 3 power
\newcommand{\damagerankfourlow}[1]
{1d10 #1 damage plus 1d6 per 4 power}

\newcommand{\damagerankfive}[1]
{2d6 #1 damage plus 1d6 per 3 power}
\newcommand{\damagerankfivehigh}[1]
{1d10 per 3 power #1 damage} % Or could use d6 per 2 power, but that's weaker
\newcommand{\damagerankfivelow}[1]
{2d8 #1 damage plus 1d6 per 4 power}

\newcommand{\damageranksix}[1]
{1d10 #1 damage plus 1d10 per 3 power}
\newcommand{\damageranksixhigh}[1]
{1d8 per 2 power #1 damage}
\newcommand{\damageranksixlow}[1]
{4d6 #1 damage plus 1d6 per 4 power} % many options

\newcommand{\damagerankseven}[1]
{2d10 #1 damage plus d10 per 3 power}
\newcommand{\damageranksevenhigh}[1]
{1d10 per 2 power #1 damage}
\newcommand{\damageranksevenlow}[1]
{4d6 #1 damage plus 1d6 per 2 power} % many options
