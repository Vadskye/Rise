% create bordered frames
\newmdenv{fullborder}
\newmdenv[leftline=false,rightline=false]{topandbottomborders}

%Set the spacing of lists
\newenvironment{enumerate*}
{\begin{enumerate}
  \setlength{\leftmargin}{0em}
  \setlength{\topsep}{1pt}
  \setlength{\itemsep}{1pt}
  \setlength{\parskip}{0pt}
  \setlength{\parsep}{0pt}}
{\end{enumerate}}
\newenvironment{itemblank}
{\begin{itemize}[label={}]
  \setlength{\leftmargin}{0em}
  \setlength{\topsep}{1pt}
  \setlength{\itemsep}{1pt}
  \setlength{\parskip}{0pt}
  \setlength{\parsep}{0pt}}
{\end{itemize}}

%Define a custom table that uses that coloring
\newenvironment{dtable}
{\begin{table}[htb!]
  \small
  \rowcolors{1}{white}{tbrown}}
{\end{table}}
%Plus a custom table that takes up two columns
\newenvironment{dtable*}
{\begin{table*}[htb!]
  \small
  \rowcolors{1}{white}{tbrown}}
{\end{table*}}
%And one more for two-column tables that need fewer restrictions
\newenvironment{dtable!*}
{\begin{table*}[htb!]
    \small
    \rowcolors{1}{white}{tbrown}
}{
    \end{table*}
}

% small text for the feats table
\newenvironment{longtabuwrapper}
{
    \onecolumn
    \small
    \taburowcolors [2] 2{tbrown .. white}
}
{\twocolumn}

\newenvironment{spelltable}
{\begin{table}[htb!]}
{\end{table}}

%A list for sorcerer/wizard spells
\newenvironment{swspelllist}
{\begin{description}[nosep,font=\normalfont,leftmargin=4.25em,style=nextline,itemindent=-1em]}
{\end{description}}
%A list for normal spells
\newenvironment{spelllist}
{\begin{description}[nosep,font=\normalfont,leftmargin=2.25em,style=nextline,itemindent=-1em]}
{\end{description}}
%A list for rituals
\newenvironment{rituallist}
{\begin{description}[nosep,font=\normalfont,leftmargin=4.5em,style=nextline,itemindent=-1em]}
{\end{description}}


\newenvironment{mstatblock}{\leftskip 0.1in \parindent-0.1in}{}

\newenvironment{wildaspect}
{\begin{enumerate*}\setcounter{enumi}{1}}
{\end{enumerate*}}

\newenvironment{greaterwildaspect}
{\begin{enumerate*}\setcounter{enumi}{9}}
{\end{enumerate*}}

\newenvironment{spellhealthy}
{\parhead*{Healthy Effect}}
{}
\newenvironment{spellblood}
{\parhead*{Bloodied Effect}}
{}

\DeclareDocumentEnvironment{spellmargin}{}
{\par\setlength{\leftskip}{1em}}
{\par\setlength{\leftskip}{0pt}}

\DeclareDocumentEnvironment{spellmarginext}{}
{\par\setlength{\leftskip}{2em}}
{\par\setlength{\leftskip}{0pt}}

\ExplSyntaxOn

\DeclareDocumentEnvironment{fakehang}{}
{
    \setlength{\parindent}{2em}
    \everypar{\hangindent=1em}
}
{
    \par
}


% with a star, don't include \spellline
\DeclareDocumentEnvironment{spelltarget}{s o m t{l} o}
{\IfBooleanF{#1}{\spellline}
    \IfNoValueTF{#5}
    {\spelltgt{#3}[#2]}
    {
        \IfBooleanTF{#4}
        {\spelltgt{#3}[#2]\parhead{Attack} #5}
        {\spelltwocol{\spelltgt{#3}[#2]}{\spellatk{#5}}}
    }
    \begin{spellmargin}
}
{
    \end{spellmargin}
}

% same thing, but plural
\DeclareDocumentEnvironment{spelltargets}{s o m t{l} o}
{\IfBooleanF{#1}{\spellline}
    \IfNoValueTF{#5}
    {\spelltgts{#3}[#2]}
    {
        \IfBooleanTF{#4}
        {\spelltgts{#3}[#2]\parhead{Attack} #5}
        {\spelltwocol{\spelltgts{#3}[#2]}{\spellatk{#5}}}
    }
    \begin{spellmargin}
}
{
    \end{spellmargin}
}

\DeclareDocumentEnvironment{spelltrigger}{m o}
{
    \IfValueTF{#2}
    {
        \spelltwocol{\parhead{Trigger} #1}{#2}
    }
    {
        \parhead*{Trigger} #1
    }
    %\begin{spellmargin}
}
{
    %\end{spellmargin}
}

% with a star, include \spellline
\DeclareDocumentEnvironment{spellattack}{s m}
{
    \IfBooleanT{#1}{\spellline}
    \spellatk{#2}
    \begin{spellmargin}
}
{
    \end{spellmargin}
}

% with a star, include \spellline
\DeclareDocumentEnvironment{spellattacktriggered}{s m}
{
    \IfBooleanT{#1}{\spellline}
    \parhead*{Triggered~Attack} #2
    \begin{spellmargin}
}
{
    \end{spellmargin}
}

% with a star, include \spellline
\DeclareDocumentEnvironment{spelltriggeredeffect}{s m}
{
    \IfBooleanT{#1}{\spellline}
    \parhead*{Triggered~Effect} #2
    \begin{spellmargin}
}
{
    \end{spellmargin}
}

\DeclareDocumentEnvironment{spellheader}{s}
{
    %\IfBooleanF{#1}{\spellline}
}
{
    %\IfBooleanF{#1}{\spellline}
}

\DeclareDocumentEnvironment{spellcontent}{}
{
    \begin{thesamepage}
}
{
    \end{thesamepage}
}

\surroundwithmdframed[
    style=spellcontent,
    leftline=true,
    topline=true,
    rightline=true,
    bottomline=true,
]{spellcontent}

\DeclareDocumentEnvironment{ability}{m o}
{
    \begin{thesamepage}
    \spelltwocol{\textbf{#1}}{
        \IfValueTF{#2}{#2}{}
    }
}
{
    \end{thesamepage}
}

\surroundwithmdframed[
    leftline=true,
    topline=true,
    rightline=true,
    bottomline=true,
    skipabove=0.25em,
    skipbelow=0.5em,
    innerleftmargin=0.25em,
    innerrightmargin=0.5em,
    innertopmargin=-0.1em,  % using thesamepage gives it a top margin
    innerbottommargin=0.25em,
]{ability}

\newmdenv[
    style=spellcontent,
    leftline=true,
    topline=false,
    rightline=true,
    bottomline=true,
    skipabove=0,
]{spellsubcontent}

\newmdenv[
    style=colorenv,
    backgroundcolor=LightCyan,
]{spelltargetinginfo}

\newmdenv[
    style=colorenv,
    backgroundcolor=LightCyan,
]{augmenttargetinginfo}

\DeclareDocumentEnvironment{spelleffects}{}
{
    \begin{fakehang}
}
{
    \end{fakehang}
}
\surroundwithmdframed[
    style=colorenv,
    backgroundcolor=Lavender,
]{spelleffects}

\DeclareDocumentEnvironment{augmenteffects}{}
{
    \begin{fakehang}
}
{
    \end{fakehang}
}
\surroundwithmdframed[
    style=colorenv,
    backgroundcolor=Lavender,
]{augmenteffects}

\DeclareDocumentEnvironment{spellfooter}{}
{
    \begin{fakehang}
}
{
    \end{fakehang}
}

\surroundwithmdframed[
    style=colorenv,
    backgroundcolor=Gainsboro,
    leftline=true,
    rightline=true,
]{spellfooter}

\DeclareDocumentEnvironment{spelltriggercolor}{}
{
    \begin{fakehang}
}
{
    \end{fakehang}
}

\surroundwithmdframed[
    style=colorenv,
    backgroundcolor=Linen
]{spelltriggercolor}

\DeclareDocumentEnvironment{dtabularx}{m m}
{
    \tabularx{#1}{#2}%
}
{
    \endtabularx
}

\surroundwithmdframed{dtabularx}

\DeclareDocumentEnvironment{spellsection}{o m o}
{
    \vspace{1em}
    \begin{thesamepage}
    \setlength{\multicolsep}{0pt}
    \begin{multicols}{2}
        \IfValueTF{#1}
        {
            \lowercase{\hypertarget{spell:#1~#2}{}}\label{spell:#1~#2}
            \hypertarget{spell:#1~#2}
                {\subsubsection{#2,~#1}}
        }
        {
            \lowercase{\hypertarget{spell:#2}{}}\label{spell:#2}
            \hypertarget{spell:#2}
                {\subsection{#2}}
        }
        \IfValueTF{#3}
        {
            \columnbreak
            \begin{flushright}
                \large\textbf{\nth{#3}~Level}
            \end{flushright}
        }
        {
            \columnbreak
            \begin{flushright}
            \end{flushright}
        }
    \end{multicols}
}
{
    \end{thesamepage}
}

% args:
%   item name
%   price
%   effective spell level
%   [body location]
%   school and descriptors
%   [activation]
%   crafting skill
%   fluff text
\DeclareDocumentEnvironment{magicitemdef}{o m o m o m o m o}
{
    \begin{thesamepage}
    \IfValueTF{#1}
    {
        \hypertarget{item:#2}{\sssecfakehref{it:#2}{#2~[#1]}}
    }
    {
        \hypertarget{item:#2}{\sssecfakehref{it:#2}{#2}}
    }
    \label{item:#2}

    \begin{spellcontent}
    \begin{spelltargetinginfo}
        \IfValueT{#3}
        {
            \mitempricewithlevel{#3}{#4}
        }

        \parhead*{Base~Item~Power} \magicitemspellpower{#4}

        \IfValueT{#5}
        {
            \parhead*{Location} #5
        }

        \parhead*{Aura} \magicitemaurastrength{#4}~#6

        \IfValueT{#7}
        {
            \parhead*{Activation} #7
        }
        \par
    \end{spelltargetinginfo}
    \begin{spelleffects}
}
{
    \end{spelleffects}
    \end{spellcontent}
    \begin{spellfooter}
        \IfValueT{#9}{\par\noindent #9}
        \par\noindent \textit{Creation~Requirements:}~#6;~
        \nth{#4}~level~spells~or~Craft~(#8)~\imath{#4*2+5}~ranks
    \end{spellfooter}
    \end{thesamepage}
}

\DeclareDocumentEnvironment{thesamepage}{}
{
    \par\nobreak\vfil\penalty0\vfilneg
    \vtop{}
}
{
    \par\xdef\tpd{\the\prevdepth}
    \prevdepth=\tpd
}

\DeclareDocumentEnvironment{spellaugments}{}
{
    \parhead{Augments}
    \begin{fakehang}
}
{
    \end{fakehang}
}
\surroundwithmdframed[
    style=colorenv,
    backgroundcolor=MistyRose,
]{spellaugments}

\DeclareDocumentEnvironment{spellcantrip}{}
{
    \fieldhead{Cantrip}
    \begin{fakehang}
}
{
    \par~If~you~cast~this~spell~as~a~cantrip,~you~do~not~need~to~spend~an~\glossterm{action~point}~to~cast~it,~but~you~cannot~apply~any~augments~to~it.
    \end{fakehang}
}
\surroundwithmdframed[
    style=colorenv,
    backgroundcolor=MistyRose,
]{spellcantrip}

\DeclareDocumentEnvironment{feat}{m m}
{
    \hypertarget{feat:#1}{\sssecfakehref{ft:#1}{#1~[#2]}}
    \label{feat:#1}
}
{}

\DeclareDocumentEnvironment{monsection}{o m m o}
{
    \vspace{1em}
    \begin{thesamepage}
    \setlength\multicolsep{0pt}
    \begin{multicols}{2}
        \IfValueTF{#1}
        {
            \lowercase{\hypertarget{mon:#1~#2}{}}
            \label{mon:#1~#2}
            \hypertarget{mon:#1~#2}
                {\subsection{#2,~#1}}
        }
        {
            \lowercase{\hypertarget{mon:#2}{}}
            \label{mon:#2}
            \hypertarget{mon:#2}
                {\subsection{#2}}
        }

        \columnbreak
        \begin{flushright}
            \large\textbf{Level~#3}
            \IfValueTF{#4}
            {
                \textbf{~[CR~#4]}
            }
            {
                \textbf{~[CR~1]}
            }
        \end{flushright}
    \end{multicols}
}
{
    \end{thesamepage}
}

\ExplSyntaxOff
